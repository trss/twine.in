var twine=twine||{};
twine.displayStats=function(){var ca=d3.time.format.utc("%Y-%m-%d-%H-%M").parse,e=d3.time.scale().range([0,730]),t=d3.scale.linear().range([400,0]),m=d3.time.scale().range([0,730]),O=d3.scale.linear().range([80,0]),F=d3.svg.axis().scale(e).orient("bottom"),P=d3.svg.axis().scale(t).orient("left"),da=d3.svg.axis().scale(m).orient("bottom"),u=d3.svg.area().interpolate("linear").x(function(b){return e(b.key)}).y0(400).y1(function(b){return t(b.value)}),ea=d3.svg.area().interpolate("linear").x(function(b){return m(b.key)}).y0(80).y1(function(b){return O(b.value)}),G=
d3.scale.category20(),h=0,H={},Q=function(b){b=b.data.key;var c=H[b];if(c)return c;c=G(h%20);h+=1;return H[b]=c},R=d3.layout.pie().value(function(b){return b.value}).sort(null),n=d3.svg.arc().innerRadius(100).outerRadius(200),S=d3.svg.arc().innerRadius(120).outerRadius(220),p=d3.svg.brush().x(m);$("#chart_canvas").children().remove();var f=d3.select("#chart_canvas").append("svg").attr("width",800).attr("height",600);f.append("defs").append("clipPath").attr("id","clip_chart").append("rect").attr("width",
730).attr("height",400);var I={x:60,y:0,scale:1},fa={x:60,y:0,scale:0.2},v={x:385,y:220,scale:1},T={x:150,y:50,scale:0.25},J=I,g=T,c=f.append("g").attr("transform","translate(60,0)"),q=f.append("g").attr("transform","translate("+g.x+", "+g.y+") scale("+g.scale+")"),w=f.append("g").attr("transform","translate(60,450)"),x=null;d3.json("stats.json",function(b,G){if(b)return console.warn(b);x=G;x.forEach(function(a){a.timestamp=ca(a.timestamp);a.amount=+a.amount});var k=crossfilter(x);k.groupAll();var ga=
k.groupAll().reduceSum(function(a){return a.amount}),U=k.dimension(function(a){return a.timestamp}),y=U.group(d3.time.day).reduceSum(function(a){return a.amount}),z=k.dimension(function(a){return a.donor_country}),A=z.group().reduceSum(function(a){return a.amount}),r=k.dimension(function(a){return a.donor_state}),s=r.group().reduceSum(function(a){return a.donor_state?a.amount:0}),V=k.dimension(function(a){return a.donor_district}),W=V.group().reduceSum(function(a){return a.donor_district?a.amount:
0});e.domain(d3.extent(x.map(function(a){return a.timestamp})));t.domain([0,y.top(1)[0].value]);m.domain(e.domain());O.domain([0,y.top(1)[0].value]);var K=y.all();twine.donations=k;twine.chart_data=K;twine.area_chart=c;twine.state=r;twine.district=V;twine.x=e;c.append("path").attr("class","areachart").datum(K).attr("clip-path","url(#clip_chart)").attr("d",u);c.append("g").attr("class","x axis").attr("transform","translate(0,400)").call(F);c.append("g").attr("class","y axis").call(P);var X=function(a,
d){var b=a.top(d);b.sort(function(a,d){return a.key.localeCompare(d.key)});return b},l=A;q.datum(X(l,13)).selectAll("path").data(R,function(a){return a.data.key}).enter().append("path").attr("fill",function(a,d){return Q(a)}).attr("class","pie_chart").on("mouseover",function(a){d3.select(this).transition().duration(800).attr("d",S);L.text(a.data.key);M.text("Rs. "+B(a.data.value))}).on("mouseout",function(a){d3.select(this).transition().duration(800).attr("d",n)}).attr("d",n);w.append("path").attr("class",
"areachart timeline").datum(K).attr("d",ea);w.append("g").attr("class","x axis").attr("transform","translate(0,80)").call(da);w.append("g").attr("class","x brush").call(p).selectAll("rect").attr("height",100);twine.resizers=w.selectAll(".resize");var ha=f.append("text").attr("x",560).attr("y",20).text("").attr("class","chart_label"),ia=f.append("text").attr("x",560).attr("y",50).text("").attr("class","chart_label"),C=f.append("text").attr("x",560).attr("y",80).text("").attr("class","chart_label"),
L=q.append("text").attr("x",0).attr("y",-10).text("Hover over arcs").attr("class","pie_label").attr("text-anchor","middle"),M=q.append("text").attr("x",0).attr("y",20).text("for details").attr("class","pie_label").attr("text-anchor","middle"),B=d3.format(","),Y=d3.time.format("%d %b %Y"),D=function(a,d,b){a.children().remove();b.forEach(function(d,b){key=0<d.value?d.key:"-";value=0<d.value?"Rs. "+B(d.value):"-";var c;if(c=H[d.key]){var e=parseInt(c.slice(1),16);c='style="background-color: '+c+"; color: "+
(127500<299*(e>>16&255)+587*(e>>8&255)+114*(e&255)?"#000":"#fff")+';"'}else c="";a.append('<tr><td class="capitalized" '+c+">"+key.toLowerCase()+"</td>-<td "+c+">"+value+"</td></tr>")});b.some(function(a,d,b){return 0<a.value})?d.show(500):d.hide(500)},Z=function(a,d){$("#top_list_label_1").text(a);$("#top_list_label_2").text(d)},aa=function(){"INDIA"==$("#country").val()?(D($("#top_regions_1"),$("#top_list_1"),s.top(5)),D($("#top_regions_2"),$("#top_list_2"),W.top(5)),Z("States","Districts")):(D($("#top_regions_1"),
$("#top_list_1"),""==$("#country").val()?A.top(5):[]),D($("#top_regions_2"),$("#top_list_2"),s.top(5)),Z("Countries","States"))},N=function(){var a=y.top(1)[0].value;t.domain([0,a+0.15*a]);c.select("path").transition().duration(2E3).attr("d",u);c.select(".y.axis").transition().duration(2E3).call(P);aa();ba()},ba=function(){ha.text(Y(e.domain()[0])+" ---- "+Y(e.domain()[1]));ia.text("Total Amount: Rs. "+B(ga.value()));L.text("");M.text("")},E=function(){var a=q.datum(X(l,13)).selectAll("path").data(R,
function(a){return a.data.key});a.enter().append("path").attr("fill",function(a,b){return Q(a)}).on("mouseover",function(a){d3.select(this).transition().duration(800).attr("d",S);L.text(a.data.key);M.text("Rs. "+B(a.data.value))}).on("mouseout",function(a){d3.select(this).transition().duration(800).attr("d",n)}).attr("d",n);a.transition().attr("d",n);a.exit().remove()};p.on("brush",function(){e.domain(p.empty()?m.domain():p.extent());p.empty()?(c.select("path").transition().duration(1E3).attr("d",
u),c.select(".x.axis").transition().duration(1E3).call(F)):(c.select("path").attr("d",u),c.select(".x.axis").call(F));U.filter(e.domain());ba();E();aa()});(function(){$("#country").append($("<option>",{value:""}).text("---All Countries---"));var a=A.all().map(function(a){return a.key}),b=a.splice(a.indexOf("INDIA"),1);b&&a.unshift(b[0]);$.each(a,function(a,b){$("#country").append($("<option>",{value:b}).text(b))});$("#state").append($("<option>",{value:""}).text("---All States---"));a=s.all().map(function(a){return a.key});
$.each(a,function(a,b){b&&$("#state").append($("<option>",{value:b}).text(b))})})();$("#chart_filters").show(500);$("#country").change(function(){var a=$("option:selected",this);$("#state").val("");r.filterAll();a&&""!=a[0].value?(z.filter(a[0].value),"INDIA"==a[0].value&&(l=s,h=0,E()),C.text("Country: "+a[0].value)):(z.filterAll(),l=A,h=0,E(),C.text("All Countries"));N()});$("#state").change(function(){var a=$("option:selected",this);$("#country").val("INDIA");z.filter("INDIA");a&&""!=a[0].value?
(r.filter(a[0].value),l=W,h=0,C.text("State: "+a[0].value)):(r.filterAll(),l=s,h=0,C.text("Country: India"));E();N()});f.append("svg:rect").attr("width",150).attr("height",100).attr("class","overlay").attr("transform","translate( 60, 0)");var ja=function(a){a?$("#country > option").each(function(){""!=this.value&&"INDIA"!=this.value&&$(this).hide()}):$("#country > option").each(function(){$(this).show()})};$(".overlay").click(function(){var a=function(a){return"translate("+a.x+", "+a.y+") scale("+
a.scale+")"};g=g==v?T:v;q.transition().duration(1E3).attr("transform",a(g));J=J==I?fa:I;c.transition().duration(1E3).attr("transform",a(J));ja(g==v);g==v&&("INDIA"!=$("#country").val()&&""!=$("#country").val())&&$("#country").val("").change()});N()})};$(document).ready(function(){twine.displayStats()});
