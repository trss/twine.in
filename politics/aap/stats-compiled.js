var twine=twine||{};
twine.displayStats=function(){var u=twine.width||520,ha=twine.overlay_width||110,R=twine.box_overlay_x_pie||95,n=u-60-10,H=60+(twine.labels_offset_x||220),ia=d3.time.format.utc("%Y-%m-%d").parse,f=d3.time.scale().range([0,n]),v=d3.scale.linear().range([400,0]),r=d3.time.scale().range([0,n]),S=d3.scale.linear().range([80,0]),I=d3.svg.axis().scale(f).orient("bottom"),T=d3.svg.axis().scale(v).orient("left"),ja=d3.svg.axis().scale(r).orient("bottom"),w=d3.svg.area().interpolate("linear").x(function(b){return f(b.key)}).y0(400).y1(function(b){return v(b.value)}),ka=
d3.svg.area().interpolate("linear").x(function(b){return r(b.key)}).y0(80).y1(function(b){return S(b.value)}),J=d3.scale.category20(),k=0,K={},U=function(b){b=b.data.key;var c=K[b];if(c)return c;c=J(k%20);k+=1;return K[b]=c},V=d3.layout.pie().value(function(b){return b.value}).sort(null),s=d3.svg.arc().innerRadius(100).outerRadius(200),W=d3.svg.arc().innerRadius(120).outerRadius(220),g=d3.svg.brush().x(r),h=d3.select("#chart_canvas").append("svg").attr("id","svg_container").attr("width",u).attr("height",
560);$("#svg_container").hide();h.append("defs").append("clipPath").attr("id","clip_chart").append("rect").attr("width",n).attr("height",400);var L={x:60,y:0,scale:1},la={x:10,y:0,scale:0.2},p={x:n/2+20,y:220,scale:1},X={x:150,y:50,scale:0.25},M=L,e=X,c=h.append("g").attr("transform","translate(60,0)"),t=h.append("g").attr("transform","translate("+e.x+", "+e.y+") scale("+e.scale+")"),x=h.append("g").attr("transform","translate(60,450)"),y=null;d3.csv("stats.csv.json",function(b,n){if(b)return console.warn(b);
$("#chart_canvas_loading").hide();$("#svg_container").show();$("#rant").show();y=n;y.forEach(function(a){a.timestamp=ia(a.timestamp);a.amount=+a.amount});var l=crossfilter(y);l.groupAll();var u=l.groupAll().reduceSum(function(a){return a.amount}),Y=l.dimension(function(a){return a.timestamp}),z=Y.group(d3.time.day).reduceSum(function(a){return a.amount}),A=l.dimension(function(a){return a.donor_country}),B=A.group().reduceSum(function(a){return a.amount}),C=l.dimension(function(a){return a.donor_state}),
m=C.group().reduceSum(function(a){return a.donor_state?a.amount:0}),Z=l.dimension(function(a){return a.donor_district}),aa=Z.group().reduceSum(function(a){return a.donor_district?a.amount:0});f.domain(d3.extent(y.map(function(a){return a.timestamp})));v.domain([0,z.top(1)[0].value]);r.domain(f.domain());S.domain([0,z.top(1)[0].value]);var N=z.all();twine.donations=l;twine.chart_data=N;twine.area_chart=c;twine.states=m;twine.district=Z;twine.x=f;twine.brush=g;c.append("path").attr("class","areachart").datum(N).attr("clip-path",
"url(#clip_chart)").attr("d",w);c.append("g").attr("class","x axis").attr("transform","translate(0,400)").call(I);c.append("g").attr("class","y axis").call(T);var ba=function(a,d){var b=a.top(d);b.sort(function(a,d){return a.key.localeCompare(d.key)});return b},q=B;t.datum(ba(q,13)).selectAll("path").data(V,function(a){return a.data.key}).enter().append("path").attr("fill",function(a,d){return U(a)}).attr("class","pie_chart").on("mouseover",function(a){d3.select(this).transition().duration(800).attr("d",
W);O.text(a.data.key);P.text("Rs. "+D(a.data.value))}).on("mouseout",function(a){d3.select(this).transition().duration(800).attr("d",s)}).attr("d",s);x.append("path").attr("class","areachart timeline").datum(N).attr("d",ka);x.append("g").attr("class","x axis").attr("transform","translate(0,80)").call(ja);x.append("g").attr("class","x brush").call(g).selectAll("rect").attr("height",100);twine.resizers=x.selectAll(".resize");var J=h.append("text").attr("x",H).attr("y",10).text("").attr("class","chart_label"),
ma=h.append("text").attr("x",H).attr("y",30).text("").attr("class","chart_label"),E=h.append("text").attr("x",H).attr("y",50).text("").attr("class","chart_label"),O=t.append("text").attr("x",0).attr("y",-10).text("Hover over arcs").attr("class","pie_label").attr("text-anchor","middle"),P=t.append("text").attr("x",0).attr("y",20).text("for details").attr("class","pie_label").attr("text-anchor","middle"),D=d3.format(","),ca=d3.time.format("%d %b %Y"),F=function(a,d,b){a.children().remove();a.append('<thead><tr><th class="region_header"></th><th>Rs.</th></tr></thead>');
b.forEach(function(d,b){key=0<d.value?d.key:"-";value=0<d.value?D(d.value):"-";var c;if(c=K[d.key]){var e=parseInt(c.slice(1),16);c='style="background-color: '+c+"; color: "+(127500<299*(e>>16&255)+587*(e>>8&255)+114*(e&255)?"#000":"#fff")+';"'}else c="";a.append('<tr><td class="capitalized" '+c+">"+key.toLowerCase()+"</td>-<td "+c+">"+value+"</td></tr>")});b.some(function(a,d,b){return 0<a.value})?d.show(500):d.hide(500)},da=function(a,d){$("#top_regions_1 .region_header").text("Top "+a);$("#top_regions_2 .region_header").text("Top "+
d)},ea=function(){"INDIA"==$("#country").val()?(F($("#top_regions_1"),$("#top_list_1"),m.top(5)),F($("#top_regions_2"),$("#top_list_2"),aa.top(5)),da("States","Districts")):(F($("#top_regions_1"),$("#top_list_1"),""==$("#country").val()?B.top(5):[]),F($("#top_regions_2"),$("#top_list_2"),m.top(5)),da("Countries","States"))},Q=function(){var a=z.top(1)[0].value;v.domain([0,a+0.15*a]);c.select("path").transition().duration(2E3).attr("d",w);c.select(".y.axis").transition().duration(2E3).call(T);ea();
fa()},fa=function(){J.text(ca(f.domain()[0])+" ---- "+ca(f.domain()[1]));ma.text("Total Amount: Rs. "+D(u.value()));O.text("");P.text("")},G=function(){var a=t.datum(ba(q,13)).selectAll("path").data(V,function(a){return a.data.key});a.enter().append("path").attr("fill",function(a,b){return U(a)}).on("mouseover",function(a){d3.select(this).transition().duration(800).attr("d",W);O.text(a.data.key);P.text("Rs. "+D(a.data.value))}).on("mouseout",function(a){d3.select(this).transition().duration(800).attr("d",
s)}).attr("d",s);a.transition().attr("d",s);a.exit().remove()},ga=function(a){f.domain(g.empty()?r.domain():g.extent());a||g.empty()?(c.select("path").transition().duration(1E3).attr("d",w),c.select(".x.axis").transition().duration(1E3).call(I)):(c.select("path").attr("d",w),c.select(".x.axis").call(I));Y.filter(f.domain());fa();G();ea()};g.on("brush",function(){ga(!1)});(function(){$("#country").append($("<option>",{value:""}).text("---All Countries---"));var a=B.all().map(function(a){return a.key}),
b=a.splice(a.indexOf("INDIA"),1);b&&a.unshift(b[0]);$.each(a,function(a,b){$("#country").append($("<option>",{value:b}).text(b))});$("#state").append($("<option>",{value:""}).text("---All States---"));a=m.all().map(function(a){return a.key});$.each(a,function(a,b){b&&$("#state").append($("<option>",{value:b}).text(b))})})();$("#chart_filters").show(500);$("#country").change(function(){var a=$("option:selected",this);$("#state").val("");C.filterAll();a&&""!=a[0].value?(A.filter(a[0].value),"INDIA"==
a[0].value&&(q=m,k=0,G()),E.text("Country: "+a[0].value)):(A.filterAll(),q=B,k=0,G(),E.text("All Countries"));Q()});$("#state").change(function(){var a=$("option:selected",this);$("#country").val("INDIA");A.filter("INDIA");a&&""!=a[0].value?(C.filter(a[0].value),q=aa,k=0,E.text("State: "+a[0].value)):(C.filterAll(),q=m,k=0,E.text("Country: India"));G();Q()});h.append("svg:rect").attr("width",ha).attr("height",100).attr("class","overlay").attr("transform","translate("+R+", 0)");var na=function(a){a?
$("#country > option").each(function(){""!=this.value&&"INDIA"!=this.value&&$(this).hide()}):$("#country > option").each(function(){$(this).show()})};$(".overlay").click(function(){var a=function(a){return"translate("+a.x+", "+a.y+") scale("+a.scale+")"};e=e==p?X:p;t.transition().duration(1E3).attr("transform",a(e));M=M==L?la:L;c.transition().duration(1E3).attr("transform",a(M));na(e==p);e==p&&"INDIA"!=$("#country").val()&&""!=$("#country").val()&&$("#country").val("").change();a=e==p?0:R;console.log("overlay_x : "+
a);$(".overlay").attr("transform","translate("+a+", 0)")});Q();(function(){$("#eg_max_state").click(function(){$("#state").val(m.top(1)[0].key).change()});$("#eg_pie_world").click(function(){e!=p&&$(".overlay").click();$("#country").val("").change()});var a=d3.time.format.utc("%Y-%m-%d").parse;$("#eg_july").click(function(){g.extent([a("2013-07-01"),a("2013-08-01")]);d3.select(".brush").call(g);ga(!0)});$("#examples").show()})()})};
$(document).ready(function(){twine.displayStats();twine.display_donation_button&&$("#donate_to_aap").delay(15E3).show(1E3)});
