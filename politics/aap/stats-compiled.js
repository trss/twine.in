var twine=twine||{};
twine.displayStats=function(){var da=d3.time.format.utc("%Y-%m-%d-%H-%M").parse,e=d3.time.scale().range([0,730]),t=d3.scale.linear().range([400,0]),p=d3.time.scale().range([0,730]),O=d3.scale.linear().range([80,0]),F=d3.svg.axis().scale(e).orient("bottom"),P=d3.svg.axis().scale(t).orient("left"),ea=d3.svg.axis().scale(p).orient("bottom"),u=d3.svg.area().interpolate("linear").x(function(b){return e(b.key)}).y0(400).y1(function(b){return t(b.value)}),fa=d3.svg.area().interpolate("linear").x(function(b){return p(b.key)}).y0(80).y1(function(b){return O(b.value)}),G=
d3.scale.category20(),k=0,H={},Q=function(b){b=b.data.key;var c=H[b];if(c)return c;c=G(k%20);k+=1;return H[b]=c},R=d3.layout.pie().value(function(b){return b.value}).sort(null),q=d3.svg.arc().innerRadius(100).outerRadius(200),S=d3.svg.arc().innerRadius(120).outerRadius(220),g=d3.svg.brush().x(p),h=d3.select("#chart_canvas").append("svg").attr("width",800).attr("height",560);h.append("defs").append("clipPath").attr("id","clip_chart").append("rect").attr("width",730).attr("height",400);var I={x:60,
y:0,scale:1},ga={x:60,y:0,scale:0.2},r={x:385,y:220,scale:1},T={x:150,y:50,scale:0.25},J=I,f=T,c=h.append("g").attr("transform","translate(60,0)"),s=h.append("g").attr("transform","translate("+f.x+", "+f.y+") scale("+f.scale+")"),v=h.append("g").attr("transform","translate(60,450)"),w=null;d3.json("stats.json",function(b,G){if(b)return console.warn(b);$("#chart_canvas_loading").hide();$("#rant").show();w=G;w.forEach(function(a){a.timestamp=da(a.timestamp);a.amount=+a.amount});var l=crossfilter(w);
l.groupAll();var ha=l.groupAll().reduceSum(function(a){return a.amount}),U=l.dimension(function(a){return a.timestamp}),x=U.group(d3.time.day).reduceSum(function(a){return a.amount}),y=l.dimension(function(a){return a.donor_country}),z=y.group().reduceSum(function(a){return a.amount}),A=l.dimension(function(a){return a.donor_state}),m=A.group().reduceSum(function(a){return a.donor_state?a.amount:0}),V=l.dimension(function(a){return a.donor_district}),W=V.group().reduceSum(function(a){return a.donor_district?
a.amount:0});e.domain(d3.extent(w.map(function(a){return a.timestamp})));t.domain([0,x.top(1)[0].value]);p.domain(e.domain());O.domain([0,x.top(1)[0].value]);var K=x.all();twine.donations=l;twine.chart_data=K;twine.area_chart=c;twine.states=m;twine.district=V;twine.x=e;twine.brush=g;c.append("path").attr("class","areachart").datum(K).attr("clip-path","url(#clip_chart)").attr("d",u);c.append("g").attr("class","x axis").attr("transform","translate(0,400)").call(F);c.append("g").attr("class","y axis").call(P);
var X=function(a,d){var b=a.top(d);b.sort(function(a,d){return a.key.localeCompare(d.key)});return b},n=z;s.datum(X(n,13)).selectAll("path").data(R,function(a){return a.data.key}).enter().append("path").attr("fill",function(a,d){return Q(a)}).attr("class","pie_chart").on("mouseover",function(a){d3.select(this).transition().duration(800).attr("d",S);L.text(a.data.key);M.text("Rs. "+B(a.data.value))}).on("mouseout",function(a){d3.select(this).transition().duration(800).attr("d",q)}).attr("d",q);v.append("path").attr("class",
"areachart timeline").datum(K).attr("d",fa);v.append("g").attr("class","x axis").attr("transform","translate(0,80)").call(ea);v.append("g").attr("class","x brush").call(g).selectAll("rect").attr("height",100);twine.resizers=v.selectAll(".resize");var ia=h.append("text").attr("x",560).attr("y",20).text("").attr("class","chart_label"),ja=h.append("text").attr("x",560).attr("y",50).text("").attr("class","chart_label"),C=h.append("text").attr("x",560).attr("y",80).text("").attr("class","chart_label"),
L=s.append("text").attr("x",0).attr("y",-10).text("Hover over arcs").attr("class","pie_label").attr("text-anchor","middle"),M=s.append("text").attr("x",0).attr("y",20).text("for details").attr("class","pie_label").attr("text-anchor","middle"),B=d3.format(","),Y=d3.time.format("%d %b %Y"),D=function(a,d,b){a.children().remove();b.forEach(function(d,b){key=0<d.value?d.key:"-";value=0<d.value?"Rs. "+B(d.value):"-";var c;if(c=H[d.key]){var e=parseInt(c.slice(1),16);c='style="background-color: '+c+"; color: "+
(127500<299*(e>>16&255)+587*(e>>8&255)+114*(e&255)?"#000":"#fff")+';"'}else c="";a.append('<tr><td class="capitalized" '+c+">"+key.toLowerCase()+"</td>-<td "+c+">"+value+"</td></tr>")});b.some(function(a,d,b){return 0<a.value})?d.show(500):d.hide(500)},Z=function(a,d){$("#top_list_label_1").text(a);$("#top_list_label_2").text(d)},aa=function(){"INDIA"==$("#country").val()?(D($("#top_regions_1"),$("#top_list_1"),m.top(5)),D($("#top_regions_2"),$("#top_list_2"),W.top(5)),Z("States","Districts")):(D($("#top_regions_1"),
$("#top_list_1"),""==$("#country").val()?z.top(5):[]),D($("#top_regions_2"),$("#top_list_2"),m.top(5)),Z("Countries","States"))},N=function(){var a=x.top(1)[0].value;t.domain([0,a+0.15*a]);c.select("path").transition().duration(2E3).attr("d",u);c.select(".y.axis").transition().duration(2E3).call(P);aa();ba()},ba=function(){ia.text(Y(e.domain()[0])+" ---- "+Y(e.domain()[1]));ja.text("Total Amount: Rs. "+B(ha.value()));L.text("");M.text("")},E=function(){var a=s.datum(X(n,13)).selectAll("path").data(R,
function(a){return a.data.key});a.enter().append("path").attr("fill",function(a,b){return Q(a)}).on("mouseover",function(a){d3.select(this).transition().duration(800).attr("d",S);L.text(a.data.key);M.text("Rs. "+B(a.data.value))}).on("mouseout",function(a){d3.select(this).transition().duration(800).attr("d",q)}).attr("d",q);a.transition().attr("d",q);a.exit().remove()},ca=function(a){e.domain(g.empty()?p.domain():g.extent());a||g.empty()?(c.select("path").transition().duration(1E3).attr("d",u),c.select(".x.axis").transition().duration(1E3).call(F)):
(c.select("path").attr("d",u),c.select(".x.axis").call(F));U.filter(e.domain());ba();E();aa()};g.on("brush",function(){ca(!1)});(function(){$("#country").append($("<option>",{value:""}).text("---All Countries---"));var a=z.all().map(function(a){return a.key}),b=a.splice(a.indexOf("INDIA"),1);b&&a.unshift(b[0]);$.each(a,function(a,b){$("#country").append($("<option>",{value:b}).text(b))});$("#state").append($("<option>",{value:""}).text("---All States---"));a=m.all().map(function(a){return a.key});
$.each(a,function(a,b){b&&$("#state").append($("<option>",{value:b}).text(b))})})();$("#chart_filters").show(500);$("#country").change(function(){var a=$("option:selected",this);$("#state").val("");A.filterAll();a&&""!=a[0].value?(y.filter(a[0].value),"INDIA"==a[0].value&&(n=m,k=0,E()),C.text("Country: "+a[0].value)):(y.filterAll(),n=z,k=0,E(),C.text("All Countries"));N()});$("#state").change(function(){var a=$("option:selected",this);$("#country").val("INDIA");y.filter("INDIA");a&&""!=a[0].value?
(A.filter(a[0].value),n=W,k=0,C.text("State: "+a[0].value)):(A.filterAll(),n=m,k=0,C.text("Country: India"));E();N()});h.append("svg:rect").attr("width",150).attr("height",100).attr("class","overlay").attr("transform","translate( 60, 0)");var ka=function(a){a?$("#country > option").each(function(){""!=this.value&&"INDIA"!=this.value&&$(this).hide()}):$("#country > option").each(function(){$(this).show()})};$(".overlay").click(function(){var a=function(a){return"translate("+a.x+", "+a.y+") scale("+
a.scale+")"};f=f==r?T:r;s.transition().duration(1E3).attr("transform",a(f));J=J==I?ga:I;c.transition().duration(1E3).attr("transform",a(J));ka(f==r);f==r&&("INDIA"!=$("#country").val()&&""!=$("#country").val())&&$("#country").val("").change()});N();(function(){$("#eg_max_state").click(function(){$("#state").val(m.top(1)[0].key).change()});$("#eg_pie_world").click(function(){f!=r&&$(".overlay").click();$("#country").val("").change()});var a=d3.time.format.utc("%Y-%m-%d").parse;$("#eg_july").click(function(){g.extent([a("2013-07-01"),
a("2013-08-01")]);d3.select(".brush").call(g);ca(!0)});$("#examples").show()})()})};$(document).ready(function(){twine.displayStats();$("#donate_to_aap").delay(15E3).show(1E3)});
