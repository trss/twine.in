var twine=twine||{};
twine.displayStats=function(){var A=d3.time.format.utc("%Y-%m-%d-%H-%M").parse,e=d3.time.scale().range([0,730]),h=d3.scale.linear().range([400,0]),f=d3.time.scale().range([0,730]),t=d3.scale.linear().range([80,0]),u=d3.svg.axis().scale(e).orient("bottom"),v=d3.svg.axis().scale(h).orient("left"),B=d3.svg.axis().scale(f).orient("bottom"),q=d3.svg.area().interpolate("linear").x(function(b){return e(b.key)}).y0(400).y1(function(b){return h(b.value)}),C=d3.svg.area().interpolate("linear").x(function(b){return f(b.key)}).y0(80).y1(function(b){return t(b.value)}),k=
d3.svg.brush().x(f);$("#chart_canvas").children().remove();var g=d3.select("#chart_canvas").append("svg").attr("width",800).attr("height",600);g.append("defs").append("clipPath").attr("id","clip_chart").append("rect").attr("width",730).attr("height",400);var d=g.append("g").attr("transform","translate(60,0)"),r=g.append("g").attr("transform","translate(60,450)"),l=null;d3.json("stats.json",function(b,g){if(b)return console.warn(b);l=g;l.forEach(function(a){a.timestamp=A(a.timestamp);a.amount=+a.amount});
var c=crossfilter(l);c.groupAll();var w=c.dimension(function(a){return a.timestamp}),m=w.group(d3.time.day).reduceSum(function(a){return a.amount}),n=c.dimension(function(a){return a.donor_country}),D=n.group(),p=c.dimension(function(a){return a.donor_state}),x=p.group().reduceSum(function(a){return a.donor_state?a.amount:0}),E=c.dimension(function(a){return a.donor_district}).group().reduceSum(function(a){return a.donor_district?a.amount:0});e.domain(d3.extent(l.map(function(a){return a.timestamp})));
h.domain([0,m.top(1)[0].value]);f.domain(e.domain());t.domain([0,m.top(1)[0].value]);c=m.all();d.append("path").datum(c).attr("clip-path","url(#clip_chart)").attr("d",q);d.append("g").attr("class","x axis").attr("transform","translate(0,400)").call(u);d.append("g").attr("class","y axis").call(v);r.append("path").attr("class","timeline").datum(c).attr("d",C);r.append("g").attr("class","x axis").attr("transform","translate(0,80)").call(B);r.append("g").attr("class","x brush").call(k).selectAll("rect").attr("height",
100);var F=d3.format(","),y=function(a,b,c){a.children().remove();c.forEach(function(b,c){key=0<b.value?b.key:"-";value=0<b.value?"Rs. "+F(b.value):"-";a.append('<tr><td class="capitalized">'+key.toLowerCase()+"</td>-<td>"+value+"</td></tr>")});c.some(function(a,b,c){return 0<a.value})?b.show(500):b.hide(500)},z=function(){y($("#top_states"),$("#top_states_list"),x.top(5));y($("#top_districts"),$("#top_districts_list"),E.top(5))},s=function(){var a=m.top(1)[0].value;h.domain([0,a+0.15*a]);d.select("path").transition().duration(2E3).attr("d",
q);d.select(".y.axis").transition().duration(2E3).call(v);z()};k.on("brush",function(){e.domain(k.empty()?f.domain():k.extent());d.select("path").attr("d",q);d.select(".x.axis").call(u);w.filter(e.domain());z()});$("#chart_filters").show(500,function(){$("#country").append($("<option>",{value:""}).text("---All Countries---"));var a=D.all().map(function(a){return a.key}),b=a.splice(a.indexOf("INDIA"),1);b&&a.unshift(b[0]);$.each(a,function(a,b){$("#country").append($("<option>",{value:b}).text(b))});
$("#state").append($("<option>",{value:""}).text("---All States---"));a=x.all().map(function(a){return a.key});$.each(a,function(a,b){b&&$("#state").append($("<option>",{value:b}).text(b))})});$("#country").change(function(){var a=$("option:selected",this);$("#state").val("");p.filterAll();a&&""!=a[0].value?n.filter(a[0].value):n.filterAll();s()});$("#state").change(function(){var a=$("option:selected",this);$("#country").val("INDIA");n.filter("INDIA");a&&""!=a[0].value?p.filter(a[0].value):p.filterAll();
s()});s()})};$(document).ready(function(){twine.displayStats()});
